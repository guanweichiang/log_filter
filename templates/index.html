<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Log Viewer with Multi-Filter</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <!-- 左側：上傳與顯示原始 log -->
    <div class="left" id="drop_zone">
      <h2>Drag & Drop Log File</h2>
      <ol id="raw_content" class="line-numbered">No data</ol>
    </div>

    <!-- 右側：管理多個 filter 與呈現結果 -->
    <div class="right">
      <h2>Filter List</h2>
      <div class="filter-input">
        <input type="text" id="filter_input" placeholder="輸入 filter 關鍵字">
        <button id="add_filter_btn">ADD Filter</button>
      </div>
      <ul id="filter_list">
        <!-- 動態產生的 filter 列表，每筆 filter 可點選刪除 -->
      </ul>
      <h2>Results</h2>
      <ol id="filtered_content" class="line-numbered">No data</ol>
    </div>
  </div>

  <script>
    let rawText = "";
    let filters = [];

    // 取得 DOM 元素
    const dropZone = document.getElementById('drop_zone');
    const rawContent = document.getElementById('raw_content');
    const filteredContent = document.getElementById('filtered_content');
    const filterInput = document.getElementById('filter_input');
    const addFilterBtn = document.getElementById('add_filter_btn');
    const filterList = document.getElementById('filter_list');

    // 拖曳上傳事件
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.borderColor = '#555';
    });

    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.style.borderColor = '#aaa';
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      const formData = new FormData();
      formData.append('file', file);

      fetch('/upload', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          rawText = data.content;
          updateRawContent(rawText);
          // 當有新的檔案時，重設 filter 與 filter 列表
          filters = [];
          updateFilterList();
          updateFilteredContent();
        } else {
          alert(data.message);
        }
      });
    });

    // 新增 filter 按鈕點擊事件
    addFilterBtn.addEventListener('click', function() {
      const keyword = filterInput.value.trim();
      if (keyword && !filters.includes(keyword)) {
        filters.push(keyword);
        filterInput.value = "";
        updateFilterList();
        updateFilteredContent();
      }
    });

    // 更新 filter 列表的顯示
    function updateFilterList() {
      filterList.innerHTML = "";
      filters.forEach((filter, index) => {
        const li = document.createElement('li');
        li.textContent = filter + " ";
        // 加入刪除按鈕
        const delBtn = document.createElement('button');
        delBtn.textContent = "刪除";
        delBtn.addEventListener('click', function() {
          filters.splice(index, 1);
          updateFilterList();
          updateFilteredContent();
        });
        li.appendChild(delBtn);
        filterList.appendChild(li);
      });
    }

    // 更新篩選結果（帶行號）
    function updateFilteredContent() {
      fetch('/filter', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: rawText, filters: filters })
      })
      .then(res => res.json())
      .then(data => {
        filteredContent.innerHTML = "";
        data.filtered.forEach(entry => {
          const li = document.createElement('li');
          li.textContent = `[${entry.line_number}] ${entry.text}`;
          filteredContent.appendChild(li);
        });
      });
    }
    // 更新原始 log 顯示（帶行號）
    function updateRawContent(text) {
      rawContent.innerHTML = "";
      text.split("\n").forEach(line => {
        const li = document.createElement('li');
        li.textContent = line;
        rawContent.appendChild(li);
      });
    }
  </script>
</body>
</html>